<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Browse Hackathons - HTverse</title>
    <link rel="stylesheet" href="css/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar">
      <div class="nav-container">
        <div class="nav-logo">
          <h2>
            <a href="index.html" style="text-decoration: none; color: #667eea"
              >HTverse</a
            >
          </h2>
        </div>
        <div class="nav-links" id="navLinks">
          <!-- Will be updated by auth.js -->
        </div>
      </div>
    </nav>

    <!-- Header Section -->
    <section
      style="
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 120px 0 40px;
        color: white;
      "
    >
      <div class="container">
        <div style="text-align: center">
          <h1 style="font-size: 3rem; margin-bottom: 1rem">
            Discover Hackathons
          </h1>
          <p style="font-size: 1.25rem; opacity: 0.9">
            Find the perfect competition to showcase your skills
          </p>
        </div>
      </div>
    </section>

    <!-- Filters Section -->
    <section
      style="
        padding: 2rem 0;
        background: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      "
    >
      <div class="container">
        <div
          style="
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            justify-content: space-between;
          "
        >
          <div
            style="
              display: flex;
              gap: 1rem;
              flex-wrap: wrap;
              align-items: center;
            "
          >
            <select
              id="categoryFilter"
              style="
                padding: 10px 12px;
                border: 2px solid #e1e5e9;
                border-radius: 6px;
                min-width: 150px;
              "
            >
              <option value="">All Categories</option>
              <option value="Web Development">Web Development</option>
              <option value="Mobile Development">Mobile Development</option>
              <option value="AI/ML">AI/ML</option>
              <option value="Blockchain">Blockchain</option>
              <option value="IoT">IoT</option>
              <option value="Game Development">Game Development</option>
              <option value="Data Science">Data Science</option>
              <option value="Cybersecurity">Cybersecurity</option>
            </select>

            <select
              id="sortFilter"
              style="
                padding: 10px 12px;
                border: 2px solid #e1e5e9;
                border-radius: 6px;
                min-width: 150px;
              "
            >
              <option value="newest">Newest First</option>
              <option value="deadline">Registration Deadline</option>
              <option value="prize">Prize Pool</option>
              <option value="oldest">Oldest First</option>
            </select>

            <select
              id="statusFilter"
              style="
                padding: 10px 12px;
                border: 2px solid #e1e5e9;
                border-radius: 6px;
                min-width: 120px;
              "
            >
              <option value="">All Status</option>
              <option value="upcoming">Upcoming</option>
              <option value="ongoing">Ongoing</option>
              <option value="completed">Completed</option>
            </select>
          </div>

          <div style="display: flex; gap: 1rem; align-items: center">
            <span id="resultsCount" style="color: #666; font-size: 0.9rem"
              >Loading...</span
            >
            <button
              id="clearFilters"
              class="btn-secondary"
              style="padding: 8px 16px"
            >
              <i class="fas fa-times"></i> Clear
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Hackathons Grid -->
    <section style="padding: 3rem 0">
      <div class="container">
        <div id="hackathonsContainer">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>Loading awesome hackathons...</p>
          </div>
        </div>

        <!-- Load More Button -->
        <div
          id="loadMoreContainer"
          style="text-align: center; margin-top: 2rem; display: none"
        >
          <button id="loadMoreBtn" class="btn-secondary">
            <i class="fas fa-plus"></i> Load More Hackathons
          </button>
        </div>
      </div>
    </section>
    
    <script src="js/auth.js"></script>
    <script src="js/hackathon.js"></script>
    <script>
      let allHackathons = [];
      let filteredHackathons = [];
      let currentUser = null;
      let displayedCount = 0;
      const HACKATHONS_PER_PAGE = 6;

      // Load page data
      document.addEventListener("DOMContentLoaded", async () => {
        await loadUserProfile();
        await loadHackathons();
        setupFilters();
      });

      async function loadUserProfile() {
        try {
          if (TokenManager.isLoggedIn()) {
            const response = await APIClient.getProfile();
            if (response.success) {
              currentUser = response.user;
            }
          }
        } catch (error) {
          console.error("Profile load error:", error);
        }
      }

      async function loadHackathons() {
        try {
          const response = await APIClient.getHackathons();
          if (response.success) {
            allHackathons = response.data;
            filteredHackathons = [...allHackathons];
            displayHackathons();
            updateResultsCount();
          }
        } catch (error) {
          console.error("Hackathons load error:", error);
          document.getElementById("hackathonsContainer").innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>Failed to Load Hackathons</h3>
                        <p>Please check your connection and try again.</p>
                        <button onclick="loadHackathons()" class="btn-primary" style="margin-top: 1rem;">
                            <i class="fas fa-refresh"></i> Retry
                        </button>
                    </div>
                `;
        }
      }

      function displayHackathons() {
        const container = document.getElementById("hackathonsContainer");

        if (filteredHackathons.length === 0) {
          container.innerHTML = `
                    <div style="text-align: center; padding: 4rem; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üîç</div>
                        <h3 style="margin-bottom: 1rem; color: #333;">No Hackathons Found</h3>
                        <p style="color: #666; margin-bottom: 2rem;">Try adjusting your filters or check back later for new hackathons.</p>
                        <button onclick="clearAllFilters()" class="btn-primary">Clear All Filters</button>
                    </div>
                `;
          document.getElementById("loadMoreContainer").style.display = "none";
          return;
        }

        // Show initial batch
        const hackathonsToShow = filteredHackathons.slice(
          0,
          displayedCount + HACKATHONS_PER_PAGE
        );
        displayedCount = hackathonsToShow.length;

        const hackathonCards = hackathonsToShow
          .map((hackathon) => createHackathonCard(hackathon))
          .join("");

        container.innerHTML = `<div class="hackathons-grid">${hackathonCards}</div>`;

        // Show/hide load more button
        const loadMoreContainer = document.getElementById("loadMoreContainer");
        if (displayedCount < filteredHackathons.length) {
          loadMoreContainer.style.display = "block";
        } else {
          loadMoreContainer.style.display = "none";
        }
      }

      function createHackathonCard(hackathon) {
        const isRegistered =
          currentUser &&
          hackathon.participants.some(
            (p) => p._id === currentUser.id || p.id === currentUser.id
          );

        const statusColors = {
          upcoming: "#667eea",
          ongoing: "#27ae60",
          completed: "#95a5a6",
          cancelled: "#e74c3c",
        };

        const registrationStatus = getRegistrationStatus(hackathon);

        return `
                <div class="hackathon-card">
                    <div class="hackathon-header">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h3>${hackathon.title}</h3>
                                <div class="prize">üèÜ ${UIHelpers.formatCurrency(
                                  hackathon.prizePool
                                )}</div>
                            </div>
                            ${
                              isRegistered
                                ? '<div style="background: #27ae60; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">‚úì JOINED</div>'
                                : ""
                            }
                        </div>
                    </div>
                    <div class="hackathon-body">
                        <div class="hackathon-meta">
                            <div class="meta-item">
                                <i class="fas fa-calendar"></i>
                                <span>${UIHelpers.formatDate(
                                  hackathon.startDate
                                )}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-clock"></i>
                                <span>Reg. until ${UIHelpers.formatDate(
                                  hackathon.registrationDeadline
                                )}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-users"></i>
                                <span>${hackathon.participants.length}/${
          hackathon.maxParticipants
        } joined</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-tag"></i>
                                <span style="color: ${
                                  statusColors[hackathon.status]
                                }; font-weight: 600;">
                                    ${
                                      hackathon.status.charAt(0).toUpperCase() +
                                      hackathon.status.slice(1)
                                    }
                                </span>
                            </div>
                        </div>
                        <p style="color: #666; font-size: 0.875rem; margin-bottom: 1rem; line-height: 1.5;">
                            ${
                              hackathon.description.length > 120
                                ? hackathon.description.substring(0, 120) +
                                  "..."
                                : hackathon.description
                            }
                        </p>
                        <div class="categories">
                            ${hackathon.categories
                              .map(
                                (cat) =>
                                  `<span class="category-tag">${cat}</span>`
                              )
                              .join("")}
                        </div>
                    </div>
                    <div class="hackathon-footer">
                        <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: #666;">
                            <i class="fas fa-user"></i>
                            <span>by ${hackathon.organizer.name}</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <a href="hackathon-detail.html?id=${
                              hackathon._id
                            }" class="btn-secondary" style="padding: 6px 12px; font-size: 0.875rem;">
                                View Details
                            </a>
                            ${registrationStatus.button}
                        </div>
                    </div>
                </div>
            `;
      }

      function getRegistrationStatus(hackathon) {
        const now = new Date();
        const regDeadline = new Date(hackathon.registrationDeadline);
        const isRegistered =
          currentUser &&
          hackathon.participants.some(
            (p) => p._id === currentUser.id || p.id === currentUser.id
          );

        if (!TokenManager.isLoggedIn()) {
          return {
            button: `<a href="login.html" class="btn-primary" style="padding: 6px 12px; font-size: 0.875rem;">Login to Join</a>`,
          };
        }

        if (isRegistered) {
          return {
            button: `<button onclick="unregisterFromHackathon('${hackathon._id}')" class="btn-danger" style="padding: 6px 12px; font-size: 0.875rem;">Leave</button>`,
          };
        }

        if (now > regDeadline) {
          return {
            button: `<button disabled class="btn-secondary" style="padding: 6px 12px; font-size: 0.875rem; opacity: 0.6;">Registration Closed</button>`,
          };
        }

        if (hackathon.participants.length >= hackathon.maxParticipants) {
          return {
            button: `<button disabled class="btn-secondary" style="padding: 6px 12px; font-size: 0.875rem; opacity: 0.6;">Full</button>`,
          };
        }

        return {
          button: `<button onclick="registerForHackathon('${hackathon._id}')" class="btn-primary" style="padding: 6px 12px; font-size: 0.875rem;">Join Now</button>`,
        };
      }

      function setupFilters() {
        const categoryFilter = document.getElementById("categoryFilter");
        const sortFilter = document.getElementById("sortFilter");
        const statusFilter = document.getElementById("statusFilter");
        const clearFilters = document.getElementById("clearFilters");

        [categoryFilter, sortFilter, statusFilter].forEach((filter) => {
          filter.addEventListener("change", applyFilters);
        });

        clearFilters.addEventListener("click", clearAllFilters);
      }

      function applyFilters() {
        const category = document.getElementById("categoryFilter").value;
        const sort = document.getElementById("sortFilter").value;
        const status = document.getElementById("statusFilter").value;

        // Filter
        filteredHackathons = allHackathons.filter((hackathon) => {
          const categoryMatch =
            !category || hackathon.categories.includes(category);
          const statusMatch = !status || hackathon.status === status;
          return categoryMatch && statusMatch;
        });

        // Sort
        filteredHackathons.sort((a, b) => {
          switch (sort) {
            case "newest":
              return new Date(b.createdAt) - new Date(a.createdAt);
            case "oldest":
              return new Date(a.createdAt) - new Date(b.createdAt);
            case "prize":
              return b.prizePool - a.prizePool;
            case "deadline":
              return (
                new Date(a.registrationDeadline) -
                new Date(b.registrationDeadline)
              );
            default:
              return 0;
          }
        });

        displayedCount = 0;
        displayHackathons();
        updateResultsCount();
      }

      function clearAllFilters() {
        document.getElementById("categoryFilter").value = "";
        document.getElementById("sortFilter").value = "newest";
        document.getElementById("statusFilter").value = "";
        applyFilters();
      }

      function updateResultsCount() {
        document.getElementById(
          "resultsCount"
        ).textContent = `Showing ${Math.min(
          displayedCount,
          filteredHackathons.length
        )} of ${filteredHackathons.length} hackathons`;
      }

      // Load more functionality
      document.getElementById("loadMoreBtn").addEventListener("click", () => {
        displayHackathons();
      });

      // Registration functions
      async function registerForHackathon(hackathonId) {
        if (!TokenManager.isLoggedIn()) {
          window.location.href = "login.html";
          return;
        }

        try {
          const response = await APIClient.registerForHackathon(hackathonId);
          if (response.success) {
            UIHelpers.showAlert(
              "Successfully registered for hackathon!",
              "success"
            );
            // Reload to update UI
            setTimeout(() => location.reload(), 1500);
          }
        } catch (error) {
          UIHelpers.showAlert(
            error.message || "Failed to register for hackathon",
            "error"
          );
        }
      }

      async function unregisterFromHackathon(hackathonId) {
        if (!confirm("Are you sure you want to leave this hackathon?")) return;

        try {
          const response = await APIClient.unregisterFromHackathon(hackathonId);
          if (response.success) {
            UIHelpers.showAlert("Successfully left the hackathon", "success");
            // Reload to update UI
            setTimeout(() => location.reload(), 1500);
          }
        } catch (error) {
          UIHelpers.showAlert(
            error.message || "Failed to leave hackathon",
            "error"
          );
        }
      }
    </script>
  </body>
</html>
